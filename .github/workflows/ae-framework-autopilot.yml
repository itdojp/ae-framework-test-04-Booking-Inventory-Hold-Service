name: ae-framework-autopilot

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - 'artifacts/runs/**'
      - 'reports/**'
  pull_request:
  schedule:
    - cron: '0 18 * * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: read
  issues: write

jobs:
  evaluate-with-ae-framework:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate machine-readable specs
        run: |
          mkdir -p artifacts/spec-validation
          ./scripts/validate-spec-assets.sh | tee artifacts/spec-validation/latest.log

      - name: Checkout ae-framework
        uses: actions/checkout@v4
        with:
          repository: itdojp/ae-framework
          path: .tools/ae-framework

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Java (formal tools)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Run local acceptance tests
        run: npm test

      - name: Install and build ae-framework
        working-directory: .tools/ae-framework
        run: |
          corepack enable
          pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile --prefer-offline
          pnpm run build

      - name: Run ae playbook (light)
        working-directory: .tools/ae-framework
        run: pnpm run codex:run
        continue-on-error: true

      - name: Setup Rust toolchain (for cspx)
        uses: dtolnay/rust-toolchain@stable
        continue-on-error: true

      - name: Cache cargo (cspx)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin/cspx
          key: ${{ runner.os }}-cspx-8a67639ea4d3f715e27feb8cd728f46866a905db
        continue-on-error: true

      - name: Install cspx (pinned)
        run: |
          set -euo pipefail
          CSPX_REPO="https://github.com/itdojp/cspx"
          CSPX_REF="8a67639ea4d3f715e27feb8cd728f46866a905db"
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/.cargo/bin:$PATH"
          if ! command -v cspx >/dev/null 2>&1; then
            cargo install --git "$CSPX_REPO" --rev "$CSPX_REF" --locked cspx
          elif ! cspx typecheck --help | grep -q -- '--summary-json'; then
            cargo install --git "$CSPX_REPO" --rev "$CSPX_REF" --locked --force cspx
          fi
          cspx --version || true
          cspx typecheck --help | grep -q -- '--summary-json'
        continue-on-error: true

      - name: Run formal smoke (CSP typecheck)
        working-directory: .tools/ae-framework
        run: pnpm run verify:csp -- --file spec/csp/cspx-smoke.cspm --mode typecheck
        continue-on-error: true

      - name: Setup TLA/Alloy assets
        run: |
          set -euo pipefail
          mkdir -p .tools/formal-tools

          curl -fsSL -o .tools/formal-tools/alloy.jar \
            https://github.com/AlloyTools/org.alloytools.alloy/releases/download/v6.2.0/org.alloytools.alloy.dist.jar || true

          TLA_URL="$(curl -fsSL https://api.github.com/repos/tlaplus/tlaplus/releases/latest \
            | python3 -c 'import sys, json; d=json.load(sys.stdin); print(next((a.get("browser_download_url","") for a in d.get("assets",[]) if a.get("name")=="tla2tools.jar"), ""))')"
          if [ -n "$TLA_URL" ]; then
            curl -fsSL -o .tools/formal-tools/tla2tools.jar "$TLA_URL" || true
          fi

          if [ -f .tools/formal-tools/tla2tools.jar ]; then
            echo "TLA_TOOLS_JAR=$GITHUB_WORKSPACE/.tools/formal-tools/tla2tools.jar" >> "$GITHUB_ENV"
          fi
          if [ -f .tools/formal-tools/alloy.jar ]; then
            echo "ALLOY_JAR=$GITHUB_WORKSPACE/.tools/formal-tools/alloy.jar" >> "$GITHUB_ENV"
            echo 'ALLOY_RUN_CMD=java -jar $ALLOY_JAR exec -q -o - -f {file}' >> "$GITHUB_ENV"
          fi

          java -version
          [ -f .tools/formal-tools/tla2tools.jar ] && echo "tla2tools.jar: present" || echo "tla2tools.jar: missing"
          [ -f .tools/formal-tools/alloy.jar ] && echo "alloy.jar: present" || echo "alloy.jar: missing"

      - name: Run formal smoke (TLA TLC)
        working-directory: .tools/ae-framework
        run: pnpm run verify:tla -- --engine=tlc --file spec/tla/DomainSpec.tla --timeout 60000
        continue-on-error: true

      - name: Run formal smoke (Alloy)
        working-directory: .tools/ae-framework
        run: pnpm run verify:alloy -- --file spec/alloy/Domain.als
        continue-on-error: true

      - name: Setup SMT solver (cvc5/z3)
        run: |
          set -euo pipefail
          solver="none"
          if command -v cvc5 >/dev/null 2>&1; then
            solver="cvc5"
          elif command -v z3 >/dev/null 2>&1; then
            solver="z3"
          else
            sudo apt-get update
            sudo apt-get install -y cvc5 || true
            if command -v cvc5 >/dev/null 2>&1; then
              solver="cvc5"
            else
              sudo apt-get install -y z3 || true
              if command -v z3 >/dev/null 2>&1; then
                solver="z3"
              fi
            fi
          fi
          echo "SMT_SOLVER=${solver}" >> "$GITHUB_ENV"
          echo "SMT solver selected: ${solver}"

      - name: Run formal smoke (SMT input binding)
        working-directory: .tools/ae-framework
        run: |
          solver="${SMT_SOLVER:-none}"
          if [ "$solver" = "none" ]; then
            echo "No SMT solver available; run verify:smt with cvc5 to keep status observable."
            solver="cvc5"
          fi
          pnpm run verify:smt -- --solver="$solver" --file "$GITHUB_WORKSPACE/spec/formal/smt/bi-hold-invariants.smt2"
        continue-on-error: true

      - name: Collect run artifacts
        id: collect
        run: |
          RUN_STAMP="$(date -u +%Y%m%dT%H%M%SZ)-${{ github.run_id }}-${{ github.run_attempt }}"
          RUN_DIR="artifacts/runs/${RUN_STAMP}"
          mkdir -p "${RUN_DIR}"
          rsync -a .tools/ae-framework/artifacts/ "${RUN_DIR}/ae-framework-artifacts/" || true
          rsync -a .tools/ae-framework/reports/ "${RUN_DIR}/ae-framework-reports/" || true
          rsync -a spec/ "${RUN_DIR}/spec-snapshot/" || true
          rsync -a configs/conformance/ "${RUN_DIR}/conformance-snapshot/" || true
          rsync -a artifacts/spec-validation/ "${RUN_DIR}/spec-validation/" || true
          cat > "${RUN_DIR}/run-manifest.json" <<EOF
          {
            "generatedAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workflow": "${{ github.workflow }}",
            "runId": "${{ github.run_id }}",
            "runAttempt": "${{ github.run_attempt }}",
            "source": "${{ github.repository }}@${{ github.sha }}",
            "toolchain": {
              "node": "22",
              "pnpm": "10",
              "aeFrameworkRepo": "itdojp/ae-framework"
            },
            "paths": {
              "artifactRoot": "${RUN_DIR}",
              "collectedFrom": ".tools/ae-framework/artifacts"
            }
          }
          EOF
          echo "run_dir=${RUN_DIR}" >> "$GITHUB_OUTPUT"

      - name: Generate evaluation summary
        if: always()
        run: |
          node scripts/generate-run-summary.mjs
          node scripts/generate-evaluation-report.mjs
          node scripts/generate-retention-review-alert.mjs
          node scripts/generate-formal-regression-alert.mjs

      - name: Sync artifact retention review issue
        if: always() && github.event_name != 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('node:fs');
            const path = require('node:path');

            const alertPath = path.join(process.env.GITHUB_WORKSPACE, 'reports', 'artifact-retention-review-alert.json');
            if (!fs.existsSync(alertPath)) {
              core.info(`alert file not found: ${alertPath}`);
              return;
            }

            const payload = JSON.parse(fs.readFileSync(alertPath, 'utf8'));
            const issue = payload?.issue;
            if (!issue || typeof issue.title !== 'string' || issue.title.length === 0) {
              core.info('Issue payload is missing. Skip sync.');
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const uniqueKey = issue.uniqueKey || '[artifact-retention-review]';
            const query = `repo:${owner}/${repo} is:issue is:open in:title "${uniqueKey}"`;
            const search = await github.rest.search.issuesAndPullRequests({ q: query, per_page: 10 });
            const openIssue = search.data.items.find((item) => !item.pull_request);

            if (issue.shouldOpen === true) {
              if (openIssue) {
                core.info(`Open issue already exists: #${openIssue.number}`);
                return;
              }

              const created = await github.rest.issues.create({
                owner,
                repo,
                title: issue.title,
                body: issue.body || 'Artifact retention review is overdue.'
              });
              core.notice(`Created issue #${created.data.number}`);
              return;
            }

            if (!openIssue) {
              core.info('No open retention-review issue. Nothing to close.');
              return;
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: openIssue.number,
              body: issue.closeComment || 'Artifact retention review is no longer overdue. Closing this issue automatically.'
            });
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: openIssue.number,
              state: 'closed'
            });
            core.notice(`Closed issue #${openIssue.number}`);

      - name: Sync formal regression issue
        if: always() && github.event_name != 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('node:fs');
            const path = require('node:path');

            const alertPath = path.join(process.env.GITHUB_WORKSPACE, 'reports', 'formal-regression-alert.json');
            if (!fs.existsSync(alertPath)) {
              core.info(`alert file not found: ${alertPath}`);
              return;
            }

            const payload = JSON.parse(fs.readFileSync(alertPath, 'utf8'));
            const issue = payload?.issue;
            if (!issue || typeof issue.title !== 'string' || issue.title.length === 0) {
              core.info('Issue payload is missing. Skip sync.');
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const uniqueKey = issue.uniqueKey || '[formal-regression-alert]';
            const query = `repo:${owner}/${repo} is:issue is:open in:title "${uniqueKey}"`;
            const search = await github.rest.search.issuesAndPullRequests({ q: query, per_page: 10 });
            const openIssue = search.data.items.find((item) => !item.pull_request);

            if (issue.shouldOpen === true) {
              if (openIssue) {
                core.info(`Open issue already exists: #${openIssue.number}`);
                return;
              }

              const created = await github.rest.issues.create({
                owner,
                repo,
                title: issue.title,
                body: issue.body || 'Formal verification regression detected.'
              });
              core.notice(`Created issue #${created.data.number}`);
              return;
            }

            if (!openIssue) {
              core.info('No open formal-regression issue. Nothing to close.');
              return;
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: openIssue.number,
              body: issue.closeComment || 'Formal regression is no longer detected. Closing this issue automatically.'
            });
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: openIssue.number,
              state: 'closed'
            });
            core.notice(`Closed issue #${openIssue.number}`);

      - name: Upload run artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ae-framework-run-${{ github.run_id }}-${{ github.run_attempt }}
          path: artifacts/runs
          if-no-files-found: warn

      - name: Commit artifact snapshot to main
        if: github.event_name != 'pull_request'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if [ ! -d artifacts/runs ]; then
            echo "artifacts/runs not found."
            exit 0
          fi
          git add artifacts/runs reports
          if git diff --cached --quiet; then
            echo "No artifact changes to commit."
            exit 0
          fi
          git commit -m "chore: archive ae-framework run ${{ github.run_id }}-${{ github.run_attempt }} [skip ci]"
          git push
